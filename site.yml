---
- hosts: all
  become: true

  pre_tasks:
    - name: Classify hosts depending on their OS distribution
      group_by:
        key: os_{{ ansible_facts['distribution'] }}

- hosts: btrfs
  become: true
  roles:
    - btrfs

- hosts: new_build
  become: true
  roles:
    - update
    - common
    - monitor
    - harden  # TODO: Limit to WAN interface
  environment:
    http_proxy: "{{ proxy_env }}"
    https_proxy: "{{ proxy_env }}"
    ftp_proxy: "{{ proxy_env }}"

- hosts: printing
  become: true
  roles:
    - printing

- hosts: lan_controller
  become: true
  roles:
    - geerlingguy.ntp
    - dnsmasq

- hosts: proxy
  become: true
  roles:
    - proxy

- hosts: media_server
  become: true
  roles:
    - geerlingguy.docker
    - mediasrv

- hosts: collab_server
  become: true
  roles:
    - geerlingguy.docker
    - collab

- hosts: workstation
  become: true
  roles:
    - desktopenv
    # - ripping
    - graphics
#    when: desktop_environment is defined  <-- ERROR! 'when' is not a valid attribute for a Play

- hosts: development
  become: true
  roles:
    - development

- hosts: gaming
  become: true
  roles:
    - gaming
#   when: desktop_environment is defined  <-- ERROR! 'when' is not a valid attribute for a Play

- hosts: vmhost
  become: true
  roles:
    - vmhost

- hosts: btrfs
  become: true
  roles:
    - snapper

- hosts: router
  become: true
  roles:
    - router
#   when: wan.ifname is defined  <-- ERROR! 'when' is not a valid attribute for a Play

- hosts: all
  become: true
  tasks:
    - name: Remove sudo-less pacman permission for `aur_builder`
      ansible.builtin.file:
        path: /etc/sudoers.d/11-install-aur_builder
        state: absent
      tags:
        - aur
        - packages
      when: ansible_facts['distribution'] == "Archlinux"

    - name: Remove 'aur_builder' user 
      ansible.builtin.user:
        name: "{{ aur.builder }}"
        state: absent
        remove: yes
      when: ansible_facts['distribution'] == "Archlinux"

    - name: Install reflector
      community.general.pacman:
        update_cache: true
        name: reflector 
        state: present
      tags:
        - packages
      when: ansible_facts['distribution'] == "Archlinux"

    - name: Update mirror list (Arch)
      ansible.builtin.command: reflector --country US,Canada --completion-percent 90 --sort rate --latest 20 --protocol https --save /etc/pacman.d/mirrorlist
      become: true
      when: ansible_facts['distribution'] == "Archlinux"

    - name: Open SSH port
      community.general.ufw:
        rule: limit
        to_port: "{{ ssh_port }}"
        proto: tcp
        comment: Rate limit OpenSSH server
      become: true
      # Only restart if the lan subnet hasn't changed
      when: ansible_facts['default_ipv4']['address'] == lan0.ip

    - name: Enable firewall
    #   ansible.builtin.command: ufw enable
      become: true
      community.general.ufw:
        state: enabled
      # Only restart if the lan subnet hasn't changed
      when: ansible_facts['default_ipv4']['address'] == lan0.ip

    - name: Generate and apply netplan configs
      become: true
      ansible.builtin.command: netplan generate && netplan apply
      # Only restart if the lan subnet hasn't changed
      when: ansible_facts['default_ipv4']['address'] == lan0.ip

    - name: Reload systemctl daemon
      ansible.builtin.command: systemctl daemon-reload
      # Only restart if the lan subnet hasn't changed
      when: ansible_facts['default_ipv4']['address'] == lan0.ip

    - name: Restart systemd-networkd
      ansible.builtin.service:
        name: systemd-networkd.service
        enabled: true
        state: restarted
      # Only restart if the lan subnet hasn't changed
      when: ansible_facts['default_ipv4']['address'] == lan0.ip

  # roles:
  #   - sshd-keyonly  # <-- Must come last because it disables root ssh
